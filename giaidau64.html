<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giải đấu bóng bàn - Loại kép 48-64 người</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .setup-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .setup-section h2 {
            margin-bottom: 15px;
            color: #FFD700;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            resize: vertical;
        }
        
        .tournament-name-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(to right, #FF512F, #F09819);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            flex: 1;
            min-width: 200px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button.secondary {
            background: linear-gradient(to right, #1D976C, #93F9B9);
        }
        
        button.export {
            background: linear-gradient(to right, #2193b0, #6dd5ed);
        }
        
        .tournament-section {
            display: none;
            margin-top: 30px;
        }
        
        .bracket-container {
            display: flex;
            justify-content: space-between;
            padding: 20px 0;
            width: 4000px;
            min-height: 100vh;
            cursor: grab;
            user-select: none;
        }
        
        .bracket-container:active {
            cursor: grabbing;
        }
        
        .round {
            min-width: 300px;
            margin: 0 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .round-header {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            font-weight: bold;
            color: #FFD700;
        }
        
        .match {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 30px;
            padding: 15px;
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
        }
        
        .match:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #FFD700;
        }
        
        .player {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            transition: all 0.3s ease;
            min-height: 40px;
            align-items: center;
        }
        
        .player.winner {
            background: rgba(0, 128, 0, 0.4);
            font-weight: bold;
        }
        
        .player.eliminated {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .player-name {
            flex-grow: 1;
        }
        
        .score-input {
            width: 50px;
            padding: 5px;
            text-align: center;
            margin-left: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 4px;
        }
        
        .match-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .winner-indicator {
            font-size: 0.9rem;
            color: #FFD700;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .winner-path {
            border: 2px solid #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .champion-section {
            text-align: center;
            padding: 30px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            margin-top: 30px;
            display: none;
        }
        
        .champion-title {
            font-size: 1.8rem;
            color: #FFD700;
            margin-bottom: 20px;
        }
        
        .champion-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .placeholder {
            color: #aaa;
            font-style: italic;
        }
        
        .win-placeholder {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .lose-placeholder {
            color: #F44336;
            font-weight: bold;
        }
        
        .bracket-viewport {
            width: 100%;
            overflow: auto;
            max-height: 80vh;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
        }
        
        .export-message {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #FFD700;
        }
        
        .scroll-instruction {
            text-align: center;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .tournament-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Giải đấu bóng bàn</h1>
            <p class="subtitle">Thể thức loại kép - 48-64 người chơi</p>
        </header>
        
        <section class="setup-section">
            <h2>Thiết lập giải đấu</h2>
            <div class="input-group">
                <label for="tournament-name">Tên giải đấu:</label>
                <input type="text" id="tournament-name" class="tournament-name-input" placeholder="Nhập tên giải đấu">
            </div>
            <div class="input-group">
                <label for="players">Nhập danh sách người chơi (48-64 người, mỗi người một dòng):</label>
                <textarea id="players" placeholder="Người chơi 1&#10;Người chơi 2&#10;...&#10;Người chơi 64"></textarea>
            </div>
            <div class="button-group">
                <button id="start-btn">Bắt đầu giải đấu</button>
                <button id="new-tournament-btn" class="secondary">Tạo giải đấu mới</button>
                <button id="check-duplicates-btn" class="secondary">Kiểm tra trận trùng</button>
                <button id="export-btn" class="export">Xuất ảnh giải đấu</button>
            </div>
            <div class="export-message" id="export-message"></div>
        </section>
        
        <section class="tournament-section" id="tournament-section">
            <div class="tournament-title" id="tournament-title">Giải đấu bóng bàn</div>
            <div class="scroll-instruction">Giữ chuột trái và kéo để di chuyển sơ đồ ngang</div>
            <div class="bracket-viewport" id="bracket-viewport">
                <div class="bracket-container" id="bracket-container">
                    <!-- Bracket will be generated here -->
                </div>
            </div>
            
            <div class="champion-section" id="champion-section">
                <div class="champion-title">NHÀ VÔ ĐỊCH</div>
                <div class="champion-name" id="champion-name">Chưa xác định</div>
            </div>
        </section>
        
        <div class="footer">
            <p>Giải đấu bóng bàn - Thể thức loại kép | Tự động cập nhật khi nhập kết quả | Được thiết kế bởi <a href="https://facebook.com/namtrt" style="color: #FF512F;" target="_blank">Nam Tran</a></p>
        </div>
    </div>

    <script>
        const nonePersonText = '<b style="color: red;">---</b>';
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('start-btn');
            const newTournamentBtn = document.getElementById('new-tournament-btn');
            const checkDuplicatesBtn = document.getElementById('check-duplicates-btn');
            const exportBtn = document.getElementById('export-btn');
            const playersTextarea = document.getElementById('players');
            const tournamentNameInput = document.getElementById('tournament-name');
            const tournamentTitle = document.getElementById('tournament-title');
            const tournamentSection = document.getElementById('tournament-section');
            const bracketContainer = document.getElementById('bracket-container');
            const bracketViewport = document.getElementById('bracket-viewport');
            const championSection = document.getElementById('champion-section');
            const championName = document.getElementById('champion-name');
            const exportMessage = document.getElementById('export-message');
            
            // Sample players for testing
            const samplePlayers = Array.from({length: 64}, (_, i) => `Người chơi ${i + 1}`);
            
            let tournament = null;
            let globalMatchId = 1;
            
            // Drag variables
            let isDragging = false;
            let startX, scrollLeft;
            
            // Load tournament from localStorage if exists
            loadTournament();
            
            // Setup drag functionality
            setupDrag();
            
            startBtn.addEventListener('click', () => {
                const players = playersTextarea.value.split('\n')
                    .map(name => name.trim())
                    .filter(name => name !== '');

                // Validate số lượng người chơi
                if (players.length < 48 || players.length > 64) {
                    alert("Số lượng người chơi phải từ 48 đến 64!");
                    return;
                }
                
                // Nếu ít hơn 64, thêm người chơi mặc định
                if (players.length < 64) {
                    const needed = 64 - players.length;
                    for (let i = 1; i <= needed; i++) {
                        players.push(nonePersonText);
                    }
                } else if (players.length > 64) {
                    alert('Chỉ sử dụng 64 người chơi đầu tiên. Các người chơi sau đã bị bỏ qua.');
                    players.splice(64);
                }
                
                const tournamentName = tournamentNameInput.value || "Giải đấu bóng bàn";
                tournamentTitle.textContent = tournamentName;
                
                tournament = createTournament(players);
                tournament.name = tournamentName;
                saveTournament();
                renderTournament();
                tournamentSection.style.display = 'block';
            });
            
            newTournamentBtn.addEventListener('click', () => {
                if (confirm('Bạn có chắc chắn muốn tạo giải đấu mới? Dữ liệu hiện tại sẽ bị xóa.')) {
                    localStorage.removeItem('pingpongTournament64');
                    playersTextarea.value = samplePlayers.join('\n');
                    tournamentNameInput.value = "";
                    tournamentTitle.textContent = "Giải đấu bóng bàn";
                    tournament = null;
                    tournamentSection.style.display = 'none';
                    championSection.style.display = 'none';
                }
            });
            
            checkDuplicatesBtn.addEventListener('click', () => {
                if (!tournament) {
                    alert('Chưa có giải đấu nào được tạo. Vui lòng tạo giải đấu trước.');
                    return;
                }
                
                const duplicateIssues = checkDuplicateMatchups();
                if (duplicateIssues.length === 0) {
                    alert('✓ Không phát hiện trận đấu trùng lặp trước tứ kết!\n\nTất cả các trận đấu đều hợp lệ.');
                } else {
                    const warningMsg = duplicateIssues.map((issue, idx) => 
                        `${idx + 1}. ${issue.players.join(' vs ')}\n   - Lần 1: ${issue.firstMatch} (Trận ${issue.globalMatchId1})\n   - Lần 2: ${issue.duplicateMatch} (Trận ${issue.globalMatchId2})`
                    ).join('\n\n');
                    alert('⚠ CẢNH BÁO: Phát hiện ' + duplicateIssues.length + ' trận đấu trùng lặp trước tứ kết!\n\n' + warningMsg + '\n\nLưu ý: Hai người chơi không nên gặp lại nhau cho đến tứ kết.');
                }
            });
            
            exportBtn.addEventListener('click', () => {
                exportMessage.textContent = "Đang tạo ảnh giải đấu, vui lòng chờ...";
                setTimeout(() => {
                    exportTournament();
                }, 500);
            });
            
            function setupDrag() {
                bracketViewport.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.pageX - bracketViewport.offsetLeft;
                    scrollLeft = bracketViewport.scrollLeft;
                    bracketViewport.style.cursor = 'grabbing';
                });
                
                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    bracketViewport.style.cursor = 'auto';
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const x = e.pageX - bracketViewport.offsetLeft;
                    const walkX = (x - startX) * 2;
                    bracketViewport.scrollLeft = scrollLeft - walkX;
                });
            }
            
            function createTournament(players) {
                globalMatchId = 1;
                // Shuffle players for random matchups
                let shuffledPlayers = [...players].sort(() => Math.random() - 0.5);

                //reorder
                shuffledPlayers = reorderShuffledPlayers(shuffledPlayers);

                // Create tournament structure
                // Vòng 1: 32 trận (64 người)
                // Vòng 2.1 (Nhánh thắng): 16 trận
                // Vòng 2.2 (Nhánh thua): 16 trận
                // Vòng 3.1 (Nhánh thắng): 8 trận
                // Vòng 3.2 (Nhánh thua): 16 trận
                // Vòng 4 (Nhánh thua): 16 trận
                // Vòng 5 (1/16): 16 trận - Bắt đầu loại trực tiếp từ 32 người
                // Vòng 6 (1/8): 8 trận
                // Vòng 7 (Tứ kết): 4 trận
                // Vòng 8 (Bán kết): 2 trận
                // Vòng 9 (Chung kết): 1 trận
                return {
                    name: tournamentNameInput.value || "Giải đấu bóng bàn",
                    rounds: [
                        createRound(1, 'Vòng 1', 32, shuffledPlayers.slice(0, 64)),
                        createRound(2, 'Vòng 2.1 (Nhánh thắng)', 16, []),
                        createRound(3, 'Vòng 2.2 (Nhánh thua)', 16, []),
                        createRound(4, 'Vòng 3.1 (Nhánh thắng)', 8, []),
                        createRound(5, 'Vòng 3.2 (Nhánh thua)', 16, []),
                        createRound(6, 'Vòng 4 (Nhánh thua)', 16, []),
                        createRound(7, 'Vòng 5 (1/16)', 16, []),
                        createRound(8, 'Vòng 6 (1/8)', 8, []),
                        createRound(9, 'Vòng 7 (Tứ kết)', 4, []),
                        createRound(10, 'Vòng 8 (Bán kết)', 2, []),
                        createRound(11, 'Vòng 9 (Chung kết)', 1, [])
                    ],
                    champion: null
                };
            }

            function reorderShuffledPlayers(shuffledPlayers) {
                // For 64 players, we might need different dash positions
                // For now, just return shuffled players
                return shuffledPlayers;
            }
            
            function createRound(roundNum, name, matchCount, players) {
                const matches = [];
                
                for (let i = 0; i < matchCount; i++) {
                    const match = {
                        id: `round-${roundNum}-match-${i+1}`,
                        globalMatchId: globalMatchId++,
                        player1: players[i*2] || null,
                        player2: players[i*2+1] || null,
                        score1: null,
                        score2: null,
                        winner: null,
                        completed: false
                    };
                    matches.push(match);
                }
                
                return {
                    roundNum,
                    name,
                    matches
                };
            }
            
            function renderTournament() {
                bracketContainer.innerHTML = '';
                let hasChampion = false;
                
                tournamentTitle.textContent = tournament.name;
                
                tournament.rounds.forEach((round, roundIndex) => {
                    const roundElement = document.createElement('div');
                    roundElement.className = 'round';
                    
                    const roundHeader = document.createElement('div');
                    roundHeader.className = 'round-header';
                    roundHeader.textContent = round.name;
                    roundElement.appendChild(roundHeader);
                    
                    round.matches.forEach((match, matchIndex) => {
                        const matchElement = document.createElement('div');
                        matchElement.className = `match ${match.completed ? 'winner-path' : ''}`;
                        matchElement.id = `match-${match.globalMatchId}`;
                        
                        const matchHeader = document.createElement('div');
                        matchHeader.className = 'match-header';
                        matchHeader.innerHTML = `Trận ${match.globalMatchId}`;
                        matchElement.appendChild(matchHeader);
                        
                        let player1Display = match.player1;
                        if (!player1Display) {
                            const sourceInfo = getSourceInfo(roundIndex, matchIndex, true);
                            player1Display = `<span class="${sourceInfo.class}">${sourceInfo.text}</span>`;
                        }
                        
                        let player2Display = match.player2;
                        if (!player2Display) {
                            const sourceInfo = getSourceInfo(roundIndex, matchIndex, false);
                            player2Display = `<span class="${sourceInfo.class}">${sourceInfo.text}</span>`;
                        }
                        
                        const player1Class = match.winner === 0 ? 'player winner' : 'player';
                        const player2Class = match.winner === 1 ? 'player winner' : 'player';
                        
                        matchElement.innerHTML += `
                            <div class="${player1Class}" data-player="0">
                                <span class="player-name">${player1Display}</span>
                                <input type="number" min="0" class="score-input" 
                                    value="${match.score1 !== null ? match.score1 : ''}">
                            </div>
                            <div class="${player2Class}" data-player="1">
                                <span class="player-name">${player2Display}</span>
                                <input type="number" min="0" class="score-input" 
                                    value="${match.score2 !== null ? match.score2 : ''}">
                            </div>
                            <div class="match-controls">
                                <button class="set-winner-btn">Xác nhận kết quả</button>
                            </div>
                            ${match.completed ? 
                                `<div class="winner-indicator">Người thắng: ${match.winner === 0 ? match.player1 : match.player2}</div>` : 
                                ''}
                        `;
                        
                        const button = matchElement.querySelector('.set-winner-btn');
                        if (button) {
                            button.addEventListener('click', () => {
                                if (!match.player1 || !match.player2) {
                                    alert('Trận đấu chưa sẵn sàng. Vui lòng chờ kết quả từ trận đấu trước.');
                                    return;
                                }
                                
                                const player1Score = parseInt(matchElement.querySelector('.player:nth-child(2) .score-input').value);
                                const player2Score = parseInt(matchElement.querySelector('.player:nth-child(3) .score-input').value);
                                
                                if (isNaN(player1Score)) {
                                    alert('Vui lòng nhập điểm cho người chơi 1');
                                    return;
                                }
                                
                                if (isNaN(player2Score)) {
                                    alert('Vui lòng nhập điểm cho người chơi 2');
                                    return;
                                }
                                
                                const winnerIndex = player1Score > player2Score ? 0 : 1;
                                
                                match.score1 = player1Score;
                                match.score2 = player2Score;
                                match.winner = winnerIndex;
                                match.completed = true;
                                
                                updateNextRounds(roundIndex, matchIndex, winnerIndex);
                                
                                if (roundIndex === 10) { // Final round
                                    tournament.champion = winnerIndex === 0 ? match.player1 : match.player2;
                                    championName.textContent = tournament.champion;
                                    championSection.style.display = 'block';
                                    hasChampion = true;
                                }
                                
                                saveTournament();
                                renderTournament();
                            });
                        }
                        
                        roundElement.appendChild(matchElement);
                    });
                    
                    bracketContainer.appendChild(roundElement);
                });
                
                if (tournament.champion) {
                    championName.textContent = tournament.champion;
                    championSection.style.display = 'block';
                } else if (hasChampion) {
                    championSection.style.display = 'block';
                } else {
                    championSection.style.display = 'none';
                }
            }
            
            function getSourceInfo(roundIndex, matchIndex, isPlayer1) {
                if (roundIndex === 0) return {text: "Chờ người chơi", class: "placeholder"};
                
                // Round 2.1 (Nhánh thắng) - 16 trận
                if (roundIndex === 1) {
                    // Winners from Round 1 (32 matches) go to Round 2.1 (16 matches)
                    // Match 0-15 of Round 1 → Match 0-7 of Round 2.1
                    // Match 16-31 of Round 1 → Match 8-15 of Round 2.1
                    const sourceMatch = matchIndex < 8 ? 
                        (matchIndex * 2 + (isPlayer1 ? 0 : 1)) : 
                        ((matchIndex - 8) * 2 + 16 + (isPlayer1 ? 0 : 1));
                    return {text: `Thắng trận ${sourceMatch + 1}`, class: "win-placeholder"};
                }
                
                // Round 2.2 (Nhánh thua) - 16 trận
                // Mapping: 49vs61, 50vs63, 51vs62, 52vs64, 53vs57, 54vs59, 55vs58, 56vs60
                if (roundIndex === 2) {
                    let sourceMatch;
                    if (matchIndex === 0) {
                        // Trận 49: Thua trận 1 vs Thua trận 13
                        sourceMatch = isPlayer1 ? 1 : 13;
                    } else if (matchIndex === 1) {
                        // Trận 50: Thua trận 2 vs Thua trận 15
                        sourceMatch = isPlayer1 ? 2 : 15;
                    } else if (matchIndex === 2) {
                        // Trận 51: Thua trận 3 vs Thua trận 14
                        sourceMatch = isPlayer1 ? 3 : 14;
                    } else if (matchIndex === 3) {
                        // Trận 52: Thua trận 4 vs Thua trận 16
                        sourceMatch = isPlayer1 ? 4 : 16;
                    } else if (matchIndex === 4) {
                        // Trận 53: Thua trận 5 vs Thua trận 9
                        sourceMatch = isPlayer1 ? 5 : 9;
                    } else if (matchIndex === 5) {
                        // Trận 54: Thua trận 6 vs Thua trận 11
                        sourceMatch = isPlayer1 ? 6 : 11;
                    } else if (matchIndex === 6) {
                        // Trận 55: Thua trận 7 vs Thua trận 10
                        sourceMatch = isPlayer1 ? 7 : 10;
                    } else if (matchIndex === 7) {
                        // Trận 56: Thua trận 8 vs Thua trận 12
                        sourceMatch = isPlayer1 ? 8 : 12;
                    } else if (matchIndex === 8) {
                        // Trận 57: Thua trận 17 vs Thua trận 21
                        sourceMatch = isPlayer1 ? 17 : 21;
                    } else if (matchIndex === 9) {
                        // Trận 58: Thua trận 18 vs Thua trận 20
                        sourceMatch = isPlayer1 ? 18 : 20;
                    } else if (matchIndex === 10) {
                        // Trận 59: Thua trận 19 vs Thua trận 23
                        sourceMatch = isPlayer1 ? 19 : 23;
                    } else if (matchIndex === 11) {
                        // Trận 60: Thua trận 22 vs Thua trận 24
                        sourceMatch = isPlayer1 ? 22 : 24;
                    } else if (matchIndex === 12) {
                        // Trận 61: Thua trận 25 vs Thua trận 29
                        sourceMatch = isPlayer1 ? 25 : 29;
                    } else if (matchIndex === 13) {
                        // Trận 62: Thua trận 26 vs Thua trận 28
                        sourceMatch = isPlayer1 ? 26 : 28;
                    } else if (matchIndex === 14) {
                        // Trận 63: Thua trận 27 vs Thua trận 31
                        sourceMatch = isPlayer1 ? 27 : 31;
                    } else if (matchIndex === 15) {
                        // Trận 64: Thua trận 30 vs Thua trận 32
                        sourceMatch = isPlayer1 ? 30 : 32;
                    }
                    return {text: `Thua trận ${sourceMatch}`, class: "lose-placeholder"};
                }
                
                // Round 3.1 (Nhánh thắng) - 8 trận
                if (roundIndex === 3) {
                    const sourceMatch = matchIndex * 2 + (isPlayer1 ? 0 : 1);
                    return {text: `Thắng trận ${33 + sourceMatch}`, class: "win-placeholder"};
                }
                
                // Round 3.2 (Nhánh thua) - 16 trận
                if (roundIndex === 4) {
                    // Losers from Round 2.1 + Winners from Round 2.2
                    if (isPlayer1) {
                        // Loser from Round 2.1
                        const sourceMatch = matchIndex < 8 ? matchIndex : matchIndex - 8;
                        return {text: `Thua trận ${33 + sourceMatch}`, class: "lose-placeholder"};
                    } else {
                        // Winner from Round 2.2
                        return {text: `Thắng trận ${49 + matchIndex}`, class: "win-placeholder"};
                    }
                }
                
                // Round 4 (Nhánh thua) - 16 trận
                if (roundIndex === 5) {
                    if (isPlayer1) {
                        return {text: `Thua trận ${49 + matchIndex}`, class: "lose-placeholder"};
                    } else {
                        return {text: `Thắng trận ${65 + matchIndex}`, class: "win-placeholder"};
                    }
                }
                
                // Round 5 (1/16) - 16 trận - Bắt đầu loại trực tiếp từ 32 người
                if (roundIndex === 6) {
                    if (isPlayer1) {
                        return {text: `Thắng trận ${49 + matchIndex}`, class: "win-placeholder"};
                    } else {
                        return {text: `Thắng trận ${81 + matchIndex}`, class: "win-placeholder"};
                    }
                }
                
                // Round 6 (1/8) - 8 trận
                if (roundIndex === 7) {
                    return {text: `Thắng trận ${97 + (matchIndex * 2) + (isPlayer1 ? 0 : 1)}`, class: "win-placeholder"};
                }
                
                // Round 7 (Tứ kết) - 4 trận
                if (roundIndex === 8) {
                    return {text: `Thắng trận ${113 + (matchIndex * 2) + (isPlayer1 ? 0 : 1)}`, class: "win-placeholder"};
                }
                
                // Round 8 (Bán kết) - 2 trận
                if (roundIndex === 9) {
                    return {text: `Thắng trận ${121 + (matchIndex * 2) + (isPlayer1 ? 0 : 1)}`, class: "win-placeholder"};
                }
                
                // Round 9 (Chung kết) - 1 trận
                if (roundIndex === 10) {
                    return {text: `Thắng trận ${125 + (isPlayer1 ? 0 : 1)}`, class: "win-placeholder"};
                }
                
                return {text: "Chờ kết quả", class: "placeholder"};
            }
            
            // Function to check for duplicate matchups before quarterfinals
            function checkDuplicateMatchups() {
                const matchHistory = new Map();
                const issues = [];
                
                // Check all rounds before quarterfinals (rounds 0-6)
                for (let roundIndex = 0; roundIndex < 7; roundIndex++) {
                    const round = tournament.rounds[roundIndex];
                    for (let matchIndex = 0; matchIndex < round.matches.length; matchIndex++) {
                        const match = round.matches[matchIndex];
                        if (match.player1 && match.player2 && 
                            match.player1 !== nonePersonText && match.player2 !== nonePersonText) {
                            
                            const players = [match.player1, match.player2].sort();
                            const key = players.join('|');
                            
                            if (matchHistory.has(key)) {
                                const previousMatch = matchHistory.get(key);
                                const previousRound = tournament.rounds[previousMatch.round];
                                const roundNames = ['Vòng 1', 'Vòng 2.1 (Nhánh thắng)', 'Vòng 2.2 (Nhánh thua)', 
                                                   'Vòng 3.1 (Nhánh thắng)', 'Vòng 3.2 (Nhánh thua)', 'Vòng 4 (Nhánh thua)', 'Vòng 5 (1/16)'];
                                issues.push({
                                    players: players,
                                    firstMatch: `${roundNames[previousMatch.round]}, Trận ${previousMatch.matchIndex + 1}`,
                                    duplicateMatch: `${roundNames[roundIndex]}, Trận ${matchIndex + 1}`,
                                    round: roundIndex + 1,
                                    globalMatchId1: previousRound.matches[previousMatch.matchIndex]?.globalMatchId || 'N/A',
                                    globalMatchId2: match.globalMatchId || 'N/A'
                                });
                            } else {
                                matchHistory.set(key, { round: roundIndex, matchIndex: matchIndex });
                            }
                        }
                    }
                }
                
                return issues;
            }
            
            function updateNextRounds(roundIndex, matchIndex, winnerIndex) {
                const currentRound = tournament.rounds[roundIndex];
                const currentMatch = currentRound.matches[matchIndex];
                const winner = winnerIndex === 0 ? currentMatch.player1 : currentMatch.player2;
                const loser = winnerIndex === 0 ? currentMatch.player2 : currentMatch.player1;
                
                // Check for duplicate matchups
                const duplicateIssues = checkDuplicateMatchups();
                if (duplicateIssues.length > 0) {
                    console.warn('⚠ Phát hiện trận đấu trùng lặp trước tứ kết:', duplicateIssues);
                }
                
                // Round 1 (32 matches, 64 players)
                if (roundIndex === 0) {
                    // Winner goes to Round 2.1 (Winners bracket)
                    const nextRound2_1 = tournament.rounds[1];
                    const targetMatchIndex = Math.floor(matchIndex / 2);
                    if (targetMatchIndex < nextRound2_1.matches.length) {
                        const targetMatch = nextRound2_1.matches[targetMatchIndex];
                        if (matchIndex % 2 === 0) {
                            targetMatch.player1 = winner;
                        } else {
                            targetMatch.player2 = winner;
                        }
                    }
                    
                    // Loser goes to Round 2.2 (Losers bracket)
                    // Mapping để tạo các cặp: 49vs61, 50vs63, 51vs62, 52vs64, 53vs57, 54vs59, 55vs58, 56vs60
                    const nextRound2_2 = tournament.rounds[2];
                    let targetMatchIndex2;
                    let targetPlayer;
                    
                    // Mapping logic để tạo các cặp đấu theo yêu cầu
                    if (matchIndex === 0) { // Trận 1 → Trận 49 (matchIndex 0)
                        targetMatchIndex2 = 0;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 12) { // Trận 13 → Trận 49 (matchIndex 0)
                        targetMatchIndex2 = 0;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 1) { // Trận 2 → Trận 50 (matchIndex 1)
                        targetMatchIndex2 = 1;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 14) { // Trận 15 → Trận 50 (matchIndex 1)
                        targetMatchIndex2 = 1;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 2) { // Trận 3 → Trận 51 (matchIndex 2)
                        targetMatchIndex2 = 2;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 13) { // Trận 14 → Trận 51 (matchIndex 2)
                        targetMatchIndex2 = 2;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 3) { // Trận 4 → Trận 52 (matchIndex 3)
                        targetMatchIndex2 = 3;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 15) { // Trận 16 → Trận 52 (matchIndex 3)
                        targetMatchIndex2 = 3;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 4) { // Trận 5 → Trận 53 (matchIndex 4)
                        targetMatchIndex2 = 4;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 8) { // Trận 9 → Trận 53 (matchIndex 4)
                        targetMatchIndex2 = 4;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 5) { // Trận 6 → Trận 54 (matchIndex 5)
                        targetMatchIndex2 = 5;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 10) { // Trận 11 → Trận 54 (matchIndex 5)
                        targetMatchIndex2 = 5;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 6) { // Trận 7 → Trận 55 (matchIndex 6)
                        targetMatchIndex2 = 6;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 9) { // Trận 10 → Trận 55 (matchIndex 6)
                        targetMatchIndex2 = 6;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 7) { // Trận 8 → Trận 56 (matchIndex 7)
                        targetMatchIndex2 = 7;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 11) { // Trận 12 → Trận 56 (matchIndex 7)
                        targetMatchIndex2 = 7;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 16) { // Trận 17 → Trận 57 (matchIndex 8)
                        targetMatchIndex2 = 8;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 20) { // Trận 21 → Trận 57 (matchIndex 8)
                        targetMatchIndex2 = 8;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 17) { // Trận 18 → Trận 58 (matchIndex 9)
                        targetMatchIndex2 = 9;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 19) { // Trận 20 → Trận 58 (matchIndex 9)
                        targetMatchIndex2 = 9;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 18) { // Trận 19 → Trận 59 (matchIndex 10)
                        targetMatchIndex2 = 10;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 22) { // Trận 23 → Trận 59 (matchIndex 10)
                        targetMatchIndex2 = 10;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 21) { // Trận 22 → Trận 60 (matchIndex 11)
                        targetMatchIndex2 = 11;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 23) { // Trận 24 → Trận 60 (matchIndex 11)
                        targetMatchIndex2 = 11;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 24) { // Trận 25 → Trận 61 (matchIndex 12)
                        targetMatchIndex2 = 12;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 28) { // Trận 29 → Trận 61 (matchIndex 12)
                        targetMatchIndex2 = 12;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 25) { // Trận 26 → Trận 62 (matchIndex 13)
                        targetMatchIndex2 = 13;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 27) { // Trận 28 → Trận 62 (matchIndex 13)
                        targetMatchIndex2 = 13;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 26) { // Trận 27 → Trận 63 (matchIndex 14)
                        targetMatchIndex2 = 14;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 30) { // Trận 31 → Trận 63 (matchIndex 14)
                        targetMatchIndex2 = 14;
                        targetPlayer = 'player2';
                    } else if (matchIndex === 29) { // Trận 30 → Trận 64 (matchIndex 15)
                        targetMatchIndex2 = 15;
                        targetPlayer = 'player1';
                    } else if (matchIndex === 31) { // Trận 32 → Trận 64 (matchIndex 15)
                        targetMatchIndex2 = 15;
                        targetPlayer = 'player2';
                    }
                    
                    if (targetMatchIndex2 !== undefined && targetMatchIndex2 < nextRound2_2.matches.length) {
                        const targetMatch = nextRound2_2.matches[targetMatchIndex2];
                        targetMatch[targetPlayer] = loser;
                    }
                }
                // Round 2.1 (Winners bracket) - 16 matches
                else if (roundIndex === 1) {
                    // Winner goes to Round 3.1 (Winners bracket)
                    const nextRound3_1 = tournament.rounds[3];
                    const targetMatchIndex = Math.floor(matchIndex / 2);
                    if (targetMatchIndex < nextRound3_1.matches.length) {
                        const targetMatch = nextRound3_1.matches[targetMatchIndex];
                        if (matchIndex % 2 === 0) {
                            targetMatch.player1 = winner;
                        } else {
                            targetMatch.player2 = winner;
                        }
                    }
                    
                    // Loser goes to Round 3.2 (Losers bracket)
                    const nextRound3_2 = tournament.rounds[4];
                    if (matchIndex < nextRound3_2.matches.length) {
                        nextRound3_2.matches[matchIndex].player1 = loser;
                    }
                }
                // Round 2.2 (Losers bracket) - 16 matches
                else if (roundIndex === 2) {
                    // Winner goes to Round 3.2 (Losers bracket)
                    const nextRound3_2 = tournament.rounds[4];
                    if (matchIndex < nextRound3_2.matches.length) {
                        nextRound3_2.matches[matchIndex].player2 = winner;
                    }
                }
                // Round 3.1 (Winners bracket) - 8 matches
                else if (roundIndex === 3) {
                    // Winner goes to Round 5 (1/16) - Direct elimination starts
                    const nextRound5 = tournament.rounds[6];
                    if (matchIndex < nextRound5.matches.length) {
                        nextRound5.matches[matchIndex].player1 = winner;
                    }
                    
                    // Loser goes to Round 4 (Losers bracket)
                    const nextRound4 = tournament.rounds[5];
                    if (matchIndex < nextRound4.matches.length) {
                        nextRound4.matches[matchIndex].player1 = loser;
                    }
                }
                // Round 3.2 (Losers bracket) - 16 matches
                else if (roundIndex === 4) {
                    // Winner goes to Round 4 (Losers bracket)
                    const nextRound4 = tournament.rounds[5];
                    if (matchIndex < nextRound4.matches.length) {
                        nextRound4.matches[matchIndex].player2 = winner;
                    }
                }
                // Round 4 (Losers bracket) - 16 matches
                else if (roundIndex === 5) {
                    // Winner goes to Round 5 (1/16)
                    const nextRound5 = tournament.rounds[6];
                    if (matchIndex < nextRound5.matches.length) {
                        nextRound5.matches[matchIndex].player2 = winner;
                    }
                }
                // Round 5 (1/16) - 16 matches - Direct elimination from 32 players
                else if (roundIndex === 6) {
                    // Winner goes to Round 6 (1/8)
                    const nextRound6 = tournament.rounds[7];
                    const targetMatchIndex = Math.floor(matchIndex / 2);
                    if (targetMatchIndex < nextRound6.matches.length) {
                        const targetMatch = nextRound6.matches[targetMatchIndex];
                        if (matchIndex % 2 === 0) {
                            targetMatch.player1 = winner;
                        } else {
                            targetMatch.player2 = winner;
                        }
                    }
                }
                // Round 6 (1/8) - 8 matches
                else if (roundIndex === 7) {
                    // Winner goes to Round 7 (Tứ kết)
                    const nextRound7 = tournament.rounds[8];
                    const targetMatchIndex = Math.floor(matchIndex / 2);
                    if (targetMatchIndex < nextRound7.matches.length) {
                        const targetMatch = nextRound7.matches[targetMatchIndex];
                        if (matchIndex % 2 === 0) {
                            targetMatch.player1 = winner;
                        } else {
                            targetMatch.player2 = winner;
                        }
                    }
                }
                // Round 7 (Tứ kết) - 4 matches
                else if (roundIndex === 8) {
                    // Winner goes to Round 8 (Bán kết)
                    const nextRound8 = tournament.rounds[9];
                    const targetMatchIndex = Math.floor(matchIndex / 2);
                    if (targetMatchIndex < nextRound8.matches.length) {
                        const targetMatch = nextRound8.matches[targetMatchIndex];
                        if (matchIndex % 2 === 0) {
                            targetMatch.player1 = winner;
                        } else {
                            targetMatch.player2 = winner;
                        }
                    }
                }
                // Round 8 (Bán kết) - 2 matches
                else if (roundIndex === 9) {
                    // Winner goes to Round 9 (Chung kết)
                    const nextRound9 = tournament.rounds[10];
                    if (nextRound9.matches.length > 0) {
                        if (matchIndex === 0) {
                            nextRound9.matches[0].player1 = winner;
                        } else {
                            nextRound9.matches[0].player2 = winner;
                        }
                    }
                }
            }
            
            function saveTournament() {
                if (tournament) {
                    const saveData = {
                        tournament: tournament,
                        players: playersTextarea.value,
                        tournamentName: tournamentNameInput.value
                    };
                    localStorage.setItem('pingpongTournament64', JSON.stringify(saveData));
                }
            }
            
            function loadTournament() {
                const savedData = localStorage.getItem('pingpongTournament64');
                if (savedData) {
                    const { tournament: savedTournament, players, tournamentName } = JSON.parse(savedData);
                    tournament = savedTournament;
                    playersTextarea.value = players;
                    tournamentNameInput.value = tournamentName || "";
                    
                    if (tournament) {
                        renderTournament();
                        tournamentSection.style.display = 'block';
                        
                        if (tournament.champion) {
                            championName.textContent = tournament.champion;
                            championSection.style.display = 'block';
                        }
                    }
                } else {
                    playersTextarea.value = samplePlayers.join('\n');
                }
            }
            
            function exportTournament() {
                const exportContainer = document.createElement('div');
                exportContainer.style.position = 'absolute';
                exportContainer.style.left = '-9999px';
                exportContainer.style.width = bracketContainer.offsetWidth + 'px';
                exportContainer.style.padding = '20px';
                exportContainer.style.background = 'linear-gradient(135deg, #1a2a6c, #b21f1f)';
                
                const titleElement = document.createElement('div');
                titleElement.className = 'tournament-title';
                titleElement.textContent = tournament.name;
                exportContainer.appendChild(titleElement);
                
                exportContainer.appendChild(bracketContainer.cloneNode(true));
                
                if (tournament.champion) {
                    const championClone = championSection.cloneNode(true);
                    championClone.style.display = 'block';
                    exportContainer.appendChild(championClone);
                }
                
                document.body.appendChild(exportContainer);
                
                html2canvas(exportContainer, {
                    scale: 2,
                    backgroundColor: null,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'giai-dau-bong-ban-64.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    document.body.removeChild(exportContainer);
                    exportMessage.textContent = "Đã tạo ảnh giải đấu thành công!";
                    
                    setTimeout(() => {
                        exportMessage.textContent = "";
                    }, 3000);
                }).catch(err => {
                    console.error('Lỗi khi tạo ảnh:', err);
                    exportMessage.textContent = "Có lỗi xảy ra khi tạo ảnh. Vui lòng thử lại.";
                });
            }
        });
    </script>
</body>
</html>

